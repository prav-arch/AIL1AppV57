{% extends "base.html" %}
{% set active_tab = 'kafka_browser' %}

{% block title %}Kafka Browser - AI Assistant Platform{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% endblock %}

{% block content %}
<div class="container">
    <h1>Kafka Browser</h1>
    
    <div class="row">
        <div class="col-md-3">
            <div class="panel panel-default">
                <div class="panel-heading">Broker Count</div>
                <div class="panel-body text-center">
                    <h2>3</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="panel panel-default">
                <div class="panel-heading">Total Topics</div>
                <div class="panel-body text-center">
                    <h2>15</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="panel panel-default">
                <div class="panel-heading">Consumer Groups</div>
                <div class="panel-body text-center">
                    <h2>12</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="panel panel-default">
                <div class="panel-heading">Total Messages</div>
                <div class="panel-body text-center">
                    <h2>1,862,473</h2>
                </div>
            </div>
        </div>
    </div>
    
    <div class="panel panel-default">
        <div class="panel-heading">
            <div class="row">
                <div class="col-md-6">
                    <h3 class="panel-title">Kafka Topics</h3>
                </div>
                <div class="col-md-6 text-right">
                    <h4>Showing low-volume topics</h4>
                </div>
            </div>
        </div>
        <div class="panel-body">
            <table class="table table-striped" id="topics-table">
                <thead>
                    <tr>
                        <th>Topic Name</th>
                        <th>Partitions</th>
                        <th>Replication</th>
                        <th>Message Count</th>
                        <th>Throughput</th>
                        <th>Size</th>
                        <th>Retention</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>alerts-topic</strong></td>
                        <td>1</td>
                        <td>3</td>
                        <td class="text-muted">45</td>
                        <td>5 msg/sec</td>
                        <td>2.5 MB</td>
                        <td>90 days</td>
                        <td>2025-04-02 00:00:00</td>
                    </tr>
                    <tr>
                        <td><strong>notification-alerts</strong></td>
                        <td>2</td>
                        <td>3</td>
                        <td class="text-muted">32</td>
                        <td>3 msg/sec</td>
                        <td>1.8 MB</td>
                        <td>60 days</td>
                        <td>2025-04-15 00:00:00</td>
                    </tr>
                    <tr>
                        <td><strong>config-changes</strong></td>
                        <td>1</td>
                        <td>3</td>
                        <td class="text-muted">18</td>
                        <td>1 msg/sec</td>
                        <td>0.7 MB</td>
                        <td>180 days</td>
                        <td>2025-04-10 00:00:00</td>
                    </tr>
                    <tr>
                        <td><strong>heartbeat-signals</strong></td>
                        <td>1</td>
                        <td>3</td>
                        <td class="text-muted">48</td>
                        <td>12 msg/sec</td>
                        <td>0.3 MB</td>
                        <td>14 days</td>
                        <td>2025-04-05 00:00:00</td>
                    </tr>
                    <tr>
                        <td><strong>audit-events</strong></td>
                        <td>2</td>
                        <td>3</td>
                        <td class="text-muted">27</td>
                        <td>2 msg/sec</td>
                        <td>1.2 MB</td>
                        <td>365 days</td>
                        <td>2025-04-08 00:00:00</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="panel panel-default">
        <div class="panel-heading">Topic: logs-topic - Messages</div>
        <div class="panel-body">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="panel panel-default">
                        <div class="panel-heading">Message Count</div>
                        <div class="panel-body text-center">
                            <h4>524,892</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="panel panel-default">
                        <div class="panel-heading">Avg Message Size</div>
                        <div class="panel-body text-center">
                            <h4>1.4 KB</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="panel panel-default">
                        <div class="panel-heading">Top Partition</div>
                        <div class="panel-body text-center">
                            <h4>1</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="panel panel-default">
                        <div class="panel-heading">Message Rate</div>
                        <div class="panel-body text-center">
                            <h4>120 msg/sec</h4>
                        </div>
                    </div>
                </div>
            </div>
            
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Offset</th>
                        <th>Partition</th>
                        <th>Key</th>
                        <th>Value</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1000050</td>
                        <td>1</td>
                        <td><code>srv-web-01</code></td>
                        <td class="text-truncate" style="max-width:400px;">
                            <code>{"timestamp":"2025-05-22T04:55:12.000Z","level":"INFO","service":"api-gateway","message":"Request processed successfully","requestId":"abcd1234","duration":125}</code>
                        </td>
                        <td>2025-05-22 04:55:12</td>
                    </tr>
                    <tr>
                        <td>1000049</td>
                        <td>0</td>
                        <td><code>srv-auth-02</code></td>
                        <td class="text-truncate" style="max-width:400px;">
                            <code>{"timestamp":"2025-05-22T04:55:10.000Z","level":"WARN","service":"auth-service","message":"Rate limit exceeded","requestId":"efgh5678","duration":350}</code>
                        </td>
                        <td>2025-05-22 04:55:10</td>
                    </tr>
                    <tr>
                        <td>1000048</td>
                        <td>2</td>
                        <td><code>srv-db-01</code></td>
                        <td class="text-truncate" style="max-width:400px;">
                            <code>{"timestamp":"2025-05-22T04:55:08.000Z","level":"ERROR","service":"database","message":"Connection timeout","requestId":"ijkl9012","duration":500}</code>
                        </td>
                        <td>2025-05-22 04:55:08</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="panel panel-default">
        <div class="panel-heading">Consumer Groups</div>
        <div class="panel-body">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Group ID</th>
                        <th>Members</th>
                        <th>Topics</th>
                        <th>Total Lag</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>log-processor-group</strong></td>
                        <td>3</td>
                        <td>logs-topic, app-logs</td>
                        <td>275</td>
                        <td><span class="label label-success">Stable</span></td>
                    </tr>
                    <tr>
                        <td><strong>metrics-analyzer</strong></td>
                        <td>5</td>
                        <td>metrics-topic, system-metrics</td>
                        <td>482</td>
                        <td><span class="label label-success">Stable</span></td>
                    </tr>
                    <tr>
                        <td><strong>clickstream-processor</strong></td>
                        <td>8</td>
                        <td>clickstream-topic</td>
                        <td>8,763</td>
                        <td><span class="label label-warning">Warning</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Simple logging to show the page has loaded
console.log("Simple Bootstrap 3 Kafka Browser loaded");

// Function to run when document is ready
window.onload = function() {
    // Filter to show topics with message count less than 50 AND size less than 10MB
    document.getElementById("show-less-than-50").addEventListener("click", function() {
        var rows = document.querySelectorAll("#topics-table tbody tr");
        
        rows.forEach(function(row) {
            // Get the message count (column 4), parse the number
            var messageCountText = row.cells[3].textContent;
            var messageCount = parseInt(messageCountText.replace(/,/g, ''));
            
            // Get the size (column 6), convert to MB
            var sizeText = row.cells[5].textContent;
            var sizeInMB = 0;
            
            if (sizeText.includes("MB")) {
                sizeInMB = parseFloat(sizeText.replace(" MB", ""));
            } else if (sizeText.includes("GB")) {
                sizeInMB = parseFloat(sizeText.replace(" GB", "")) * 1024;
            } else if (sizeText.includes("KB")) {
                sizeInMB = parseFloat(sizeText.replace(" KB", "")) / 1024;
            }
            
            // Show or hide based on both criteria
            if (messageCount < 50 && sizeInMB < 10) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
        
        // Update button states
        this.classList.add("btn-primary");
        this.classList.remove("btn-default");
        document.getElementById("show-all-topics").classList.add("btn-default");
        document.getElementById("show-all-topics").classList.remove("btn-primary");
    });
    
    // Show all topics
    document.getElementById("show-all-topics").addEventListener("click", function() {
        var rows = document.querySelectorAll("#topics-table tbody tr");
        
        rows.forEach(function(row) {
            row.style.display = "";
        });
        
        // Update button states
        this.classList.add("btn-primary");
        this.classList.remove("btn-default");
        document.getElementById("show-less-than-50").classList.add("btn-default");
        document.getElementById("show-less-than-50").classList.remove("btn-primary");
    });
};
</script>
{% endblock %}